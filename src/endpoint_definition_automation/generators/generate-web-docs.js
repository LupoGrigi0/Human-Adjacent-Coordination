#!/usr/bin/env node
/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘  INTERACTIVE WEB DOCUMENTATION GENERATOR                                  â•‘
 * â•‘  Generates an HTML page with Scalar for interactive API exploration       â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * Usage: node generate-web-docs.js [--output path/to/api.html]
 *
 * This generator creates an interactive API documentation page using Scalar,
 * which provides:
 *   - Beautiful, modern API documentation UI
 *   - Built-in API testing/playground
 *   - Code examples in multiple languages
 *   - Dark theme to match HACS website
 *
 * Prerequisites:
 *   - openapi.json must exist (run generate-openapi.js first)
 *
 * @author Flair-2a84
 * @created 2026-01-03
 */

import { readFile, writeFile, mkdir } from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { SHARED_CONFIG } from '../shared-config.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
  // Input: the OpenAPI spec generated by generate-openapi.js
  openapiPath: join(SHARED_CONFIG.srcRoot, 'openapi.json'),

  // Output: the interactive docs HTML page
  defaultOutput: join(SHARED_CONFIG.repoRoot, 'public', 'docs', 'api.html'),

  // Scalar CDN URLs (using latest stable versions)
  scalar: {
    js: 'https://cdn.jsdelivr.net/npm/@scalar/api-reference@latest/dist/browser/standalone.min.js'
  },

  // Page metadata
  meta: {
    title: 'HACS API Reference',
    description: 'Interactive API documentation for the Human-Adjacent Coordination System',
    themeColor: '#0a0a0a'
  }
};

// ============================================================================
// HTML TEMPLATE
// ============================================================================

function generateHTML(openapiSpec) {
  // Embed the spec directly to avoid CORS issues and extra requests
  const specJson = JSON.stringify(openapiSpec, null, 2);
  const toolCount = Object.keys(openapiSpec['x-hacs-tools'] || {}).length;

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="${CONFIG.meta.description}">
  <meta name="theme-color" content="${CONFIG.meta.themeColor}">
  <title>${CONFIG.meta.title}</title>

  <!-- Fonts (matching HACS website) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">

  <style>
    /* Base reset and HACS theme integration */
    :root {
      --color-bg-base: #0a0a0a;
      --color-bg-elevated: #111111;
      --color-purple-500: #a855f7;
      --color-purple-400: #c084fc;
      --color-cyan-400: #22d3ee;
      --nav-height: 64px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--color-bg-base);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Navigation bar matching HACS website */
    .docs-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1000;
    }

    .docs-nav__logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }

    .docs-nav__logo svg {
      width: 28px;
      height: 28px;
      color: var(--color-purple-400);
    }

    .docs-nav__links {
      display: flex;
      gap: 24px;
      margin-left: auto;
      list-style: none;
      padding: 0;
      margin: 0 0 0 auto;
    }

    .docs-nav__link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .docs-nav__link:hover {
      color: white;
    }

    .docs-nav__link--active {
      color: var(--color-purple-400);
    }

    /* Scalar container */
    .scalar-container {
      padding-top: var(--nav-height);
      min-height: 100vh;
    }

    /* Scalar theme customization - targeting Scalar's CSS variables */
    :root {
      --scalar-background-1: #0a0a0a;
      --scalar-background-2: #111111;
      --scalar-background-3: #1a1a1a;
      --scalar-border-color: rgba(255, 255, 255, 0.1);
      --scalar-color-1: rgba(255, 255, 255, 0.95);
      --scalar-color-2: rgba(255, 255, 255, 0.7);
      --scalar-color-3: rgba(255, 255, 255, 0.5);
      --scalar-color-accent: #a855f7;
    }

    /* Badge for live playground */
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--color-purple-500), var(--color-cyan-400));
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      margin-left: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .live-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Loading state */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - var(--nav-height));
      color: rgba(255, 255, 255, 0.7);
      gap: 16px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(168, 85, 247, 0.2);
      border-top-color: var(--color-purple-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tool count badge */
    .tool-count {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin-left: 8px;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .docs-nav__links {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation matching HACS website -->
  <nav class="docs-nav">
    <a href="/" class="docs-nav__logo">
      <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" opacity="0.3"/>
        <circle cx="16" cy="8" r="3" fill="currentColor"/>
        <circle cx="8" cy="20" r="3" fill="currentColor"/>
        <circle cx="24" cy="20" r="3" fill="currentColor"/>
        <line x1="16" y1="11" x2="10" y2="18" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
        <line x1="16" y1="11" x2="22" y2="18" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
        <line x1="11" y1="20" x2="21" y2="20" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
      </svg>
      HACS
      <span class="live-badge">Live API</span>
      <span class="tool-count">${toolCount} endpoints</span>
    </a>
    <ul class="docs-nav__links">
      <li><a href="/" class="docs-nav__link">Home</a></li>
      <li><a href="/about.html" class="docs-nav__link">About</a></li>
      <li><a href="/docs/" class="docs-nav__link docs-nav__link--active">Docs</a></li>
      <li><a href="/team/" class="docs-nav__link">Team</a></li>
      <li><a href="/contact.html" class="docs-nav__link">Contact</a></li>
    </ul>
  </nav>

  <!-- Scalar API Reference -->
  <div class="scalar-container">
    <div id="api-reference" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading API documentation...</p>
    </div>
  </div>

  <!-- Embedded OpenAPI Specification -->
  <script id="api-spec" type="application/json">
${specJson}
  </script>

  <!-- Scalar Standalone -->
  <script src="${CONFIG.scalar.js}"></script>
  <script>
    // Initialize Scalar with embedded spec
    document.addEventListener('DOMContentLoaded', function() {
      const specElement = document.getElementById('api-spec');
      const spec = JSON.parse(specElement.textContent);

      const container = document.getElementById('api-reference');
      container.innerHTML = ''; // Clear loading state
      container.classList.remove('loading');

      // Initialize Scalar
      Scalar.createApiReference(container, {
        spec: {
          content: spec
        },
        configuration: {
          theme: 'purple',
          darkMode: true,
          hiddenClients: [],
          defaultHttpClient: {
            targetKey: 'javascript',
            clientKey: 'fetch'
          },
          servers: [
            {
              url: 'https://smoothcurves.nexus',
              description: 'Production HACS Server'
            }
          ]
        }
      });
    });
  </script>
</body>
</html>`;
}

// ============================================================================
// MAIN
// ============================================================================

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘  HACS Interactive Web Docs Generator                          â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  // Parse command line args
  const args = process.argv.slice(2);
  const outputIndex = args.indexOf('--output');
  const outputPath = outputIndex >= 0 ? args[outputIndex + 1] : CONFIG.defaultOutput;

  // Read OpenAPI spec
  console.log('\nğŸ“‚ Reading OpenAPI specification...');
  console.log('   Source: ' + CONFIG.openapiPath);

  let openapiSpec;
  try {
    const specContent = await readFile(CONFIG.openapiPath, 'utf-8');
    openapiSpec = JSON.parse(specContent);
    const toolCount = Object.keys(openapiSpec['x-hacs-tools'] || {}).length;
    console.log('   âœ… Loaded spec with ' + toolCount + ' tools');
  } catch (error) {
    console.error('   âŒ Failed to read OpenAPI spec: ' + error.message);
    console.error('   Run generate-openapi.js first to create the spec.');
    process.exit(1);
  }

  // Ensure output directory exists
  const outputDir = dirname(outputPath);
  try {
    await mkdir(outputDir, { recursive: true });
  } catch (error) {
    // Directory already exists, that's fine
  }

  // Generate HTML
  console.log('\nğŸ“ Generating interactive documentation...');
  const html = generateHTML(openapiSpec);

  // Write output
  await writeFile(outputPath, html, 'utf-8');
  console.log('   âœ… Written to: ' + outputPath);

  // Summary
  const toolCount = Object.keys(openapiSpec['x-hacs-tools'] || {}).length;
  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('   Tools documented: ' + toolCount);
  console.log('   Output: ' + outputPath);
  console.log('   Features:');
  console.log('     â€¢ Dark theme matching HACS website');
  console.log('     â€¢ Built-in API testing playground');
  console.log('     â€¢ Code examples in multiple languages');
  console.log('     â€¢ Responsive design');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
}

main().catch(console.error);
