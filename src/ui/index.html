<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>V2 Coordination Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- IBM Plex Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="HACS" class="logo-img">
                HACS
            </div>

            <!-- Desktop Navigation Dropdown -->
            <div class="nav-dropdown" id="nav-dropdown">
                <button class="nav-dropdown-toggle" id="nav-dropdown-toggle">
                    Menu <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="nav-dropdown-menu" id="nav-dropdown-menu">
                    <button class="nav-dropdown-item" data-tab="dashboard">Dashboard</button>
                    <button class="nav-dropdown-item" data-tab="messages">Messages <span class="nav-badge" id="unread-count" style="display:none;">0</span></button>
                    <button class="nav-dropdown-item" data-tab="projects">Projects</button>
                    <button class="nav-dropdown-item" data-tab="tasks">Tasks</button>
                    <button class="nav-dropdown-item" data-tab="lists">Lists</button>
                    <button class="nav-dropdown-item" data-tab="instances">Instances</button>
                    <div class="nav-dropdown-divider"></div>
                    <button class="nav-dropdown-item" data-tab="settings">Settings</button>
                </div>
            </div>

            <div class="header-controls">
                <div class="user-status" id="user-status">
                    <div class="user-info">
                        <span class="user-id" id="user-instance-id">Not Connected</span>
                        <span class="user-role" id="user-role">-</span>
                    </div>
                </div>

                <div class="connection-status" id="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                </div>

                <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                    <span class="theme-icon">&#9790;</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Messages Tab -->
            <div class="tab-content" id="tab-messages">
                <div class="messaging-layout">
                    <!-- Conversations Sidebar -->
                    <div class="conversations-panel">
                        <div class="panel-header">
                            <h2>Messages</h2>
                            <button class="btn-icon" id="refresh-messages-btn" title="Refresh messages">&#8635;</button>
                        </div>

                        <!-- V2 XMPP Room-based Conversation List -->
                        <!-- Structure: DMs, Projects, Roles, System -->
                        <div class="conversation-list" id="conversation-list">
                            <div class="loading-placeholder">Loading conversations...</div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="chat-panel">
                        <div class="chat-header" id="chat-header">
                            <div class="chat-recipient">
                                <span class="recipient-icon">&#128100;</span>
                                <div class="recipient-info">
                                    <span class="recipient-name">Select a conversation</span>
                                    <span class="recipient-status">-</span>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn-icon" id="chat-info-btn" title="Info">&#9432;</button>
                            </div>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <div class="empty-state">
                                <span class="empty-icon">&#128172;</span>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>

                        <div class="chat-input-area" id="chat-input-area" style="display: none;">
                            <div class="chat-input-container">
                                <input
                                    type="text"
                                    id="message-subject"
                                    placeholder="Subject (optional)"
                                    class="message-subject-input"
                                >
                                <div class="message-body-row">
                                    <textarea
                                        id="message-input"
                                        placeholder="Type a message..."
                                        rows="1"
                                    ></textarea>
                                    <button class="send-btn" id="send-btn" disabled>
                                        <span>&#10148;</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab (Default) -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="dash">
                    <!-- Dashboard Header -->
                    <div class="dash-header">
                        <h1>Dashboard</h1>
                        <span class="role-badge badge-exec" id="dash-role-badge">Executive</span>
                        <div style="flex:1"></div>
                        <button class="dash-settings-btn" id="dash-settings-btn" title="Dashboard Settings">&#9881;</button>
                    </div>

                    <!-- Desktop: grid layout with main + chat aside -->
                    <div class="dash-layout" id="dash-layout">
                        <div class="dash-main">
                            <!-- Activity Chart -->
                            <div class="dash-section" id="dash-chart">
                                <div class="loading-placeholder">Loading chart...</div>
                            </div>

                            <!-- World Info Strip -->
                            <div class="world-strip" id="dash-world" style="display:none;"></div>

                            <!-- Heatmaps (side-by-side) -->
                            <div class="hm-sbs" id="dash-heatmaps">
                                <div class="heatmap-section" id="hm-projects">
                                    <div class="section-header">Projects</div>
                                    <div class="heatmap-grid" id="hm-projects-grid"></div>
                                </div>
                                <div class="heatmap-section" id="hm-tasks">
                                    <div class="section-header">Tasks</div>
                                    <div id="hm-tasks-grid"></div>
                                </div>
                                <div class="heatmap-section" id="hm-instances">
                                    <div class="section-header">Instances</div>
                                    <div class="heatmap-grid" id="hm-instances-grid"></div>
                                </div>
                            </div>

                            <!-- PM Status Scroll -->
                            <div class="pm-scroll" id="dash-pm-status"></div>

                            <!-- Task Lists + Personal Lists -->
                            <div class="content-columns layout-tasks-lists" id="dash-lists">
                                <div class="col-card" id="dash-tasks-col">
                                    <div class="col-header">
                                        <span>Tasks</span>
                                        <span class="col-count" id="dash-tasks-count">0</span>
                                    </div>
                                    <div class="new-item-row">
                                        <span class="ni-icon">&#9654;</span>
                                        <input type="text" id="dash-new-task" placeholder="Add task..." />
                                    </div>
                                    <div id="dash-tasks-list"></div>
                                </div>
                                <div class="col-card" id="dash-personal-col">
                                    <div class="col-header">
                                        <span>Lists</span>
                                        <span class="col-count" id="dash-lists-count">0</span>
                                    </div>
                                    <div id="dash-personal-lists"></div>
                                </div>
                            </div>
                        </div>

                        <!-- PA Chat Aside -->
                        <div class="dash-chat" id="dash-pa-chat">
                            <div class="pa-chat">
                                <div class="pa-chat-header">
                                    <span class="online-dot"></span>
                                    <span>Genevieve</span>
                                    <span style="flex:1"></span>
                                    <span style="font-size:10px;color:var(--text-muted)">PA</span>
                                </div>
                                <div class="pa-chat-msgs" id="pa-chat-msgs">
                                    <div class="loading-placeholder" style="font-size:12px;">Loading messages...</div>
                                </div>
                                <div class="pa-chat-input">
                                    <input type="text" id="pa-chat-input" placeholder="Message Genevieve..." />
                                    <button id="pa-chat-send">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Dialog -->
                <dialog class="dash-settings-dialog" id="dash-settings-dialog">
                    <div class="dash-settings-content">
                        <div class="dash-settings-header">
                            <h3>Dashboard Settings</h3>
                            <button class="dash-settings-close" id="dash-settings-close">&times;</button>
                        </div>
                        <div class="dash-settings-body">
                            <div class="dash-setting-group">
                                <label>Pill Size <span class="dash-setting-val" id="ds-pill-val">34</span>px</label>
                                <input type="range" id="ds-pill-size" min="24" max="64" value="34" />
                            </div>
                            <div class="dash-setting-group">
                                <label>Pill Gap <span class="dash-setting-val" id="ds-gap-val">3</span>px</label>
                                <input type="range" id="ds-pill-gap" min="1" max="8" value="3" />
                            </div>
                            <div class="dash-setting-group">
                                <label>Border Width <span class="dash-setting-val" id="ds-border-val">2</span>px</label>
                                <input type="range" id="ds-border-width" min="1" max="5" value="2" />
                            </div>
                            <div class="dash-setting-group">
                                <label>Max Task Dots <span class="dash-setting-val" id="ds-dots-val">5</span></label>
                                <input type="range" id="ds-task-dots" min="3" max="12" value="5" />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>Activity Chart</span>
                                <input type="checkbox" id="ds-show-chart" checked />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>World Info</span>
                                <input type="checkbox" id="ds-show-world" />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>Task Heatmap</span>
                                <input type="checkbox" id="ds-show-tasks" checked />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>Instance Heatmap</span>
                                <input type="checkbox" id="ds-show-instances" checked />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>PM Status</span>
                                <input type="checkbox" id="ds-show-pm" checked />
                            </div>
                            <div class="dash-setting-toggle">
                                <span>Heatmaps Side-by-Side</span>
                                <input type="checkbox" id="ds-hm-sbs" checked />
                            </div>
                            <div class="dash-setting-group">
                                <label>OpenRouter Key</label>
                                <input type="password" id="ds-openrouter-key" placeholder="sk-or-..." style="width:100%;padding:6px 8px;font-size:12px;background:var(--surface-hover);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);" />
                            </div>
                        </div>
                        <div class="dash-settings-footer">
                            <button class="btn btn-secondary" id="dash-settings-cancel">Cancel</button>
                            <button class="btn" id="dash-settings-save">Save</button>
                        </div>
                    </div>
                </dialog>
            </div>

            <!-- Projects Tab -->
            <div class="tab-content" id="tab-projects">
                <div class="container">
                    <div class="page-header">
                        <h1>Projects</h1>
                        <button class="btn" id="new-project-btn">New Project</button>
                    </div>

                    <div class="project-grid" id="project-grid">
                        <div class="loading-placeholder">Loading projects...</div>
                    </div>

                    <!-- Project Detail View (hidden by default) - Content generated dynamically by projects.js -->
                    <div id="project-detail-view" style="display: none;"></div>
                </div>
            </div>

            <!-- Assign Instance Modal -->
            <div class="modal" id="assign-instance-modal">
                <div class="modal-backdrop"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Assign Instance to Project</h2>
                        <button class="modal-close" data-close>&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                            Select an instance to add to this project's team:
                        </p>
                        <div id="instance-select-list" class="instance-select-list">
                            <div class="loading-placeholder">Loading instances...</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-close>Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-content" id="tab-tasks">
                <div class="container">
                    <div class="page-header">
                        <h1>Tasks</h1>
                        <button class="btn" id="new-task-btn">New Task</button>
                    </div>

                    <!-- Task Filters -->
                    <div class="task-filters">
                        <select id="task-project-filter">
                            <option value="">All Projects</option>
                        </select>
                        <select id="task-status-filter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <select id="task-priority-filter">
                            <option value="">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>

                    <!-- Task Board -->
                    <div class="task-board">
                        <div class="task-column">
                            <div class="column-header">
                                <span>Pending</span>
                                <span class="column-count" id="pending-count">0</span>
                            </div>
                            <div class="task-list" id="pending-tasks"></div>
                        </div>
                        <div class="task-column">
                            <div class="column-header">
                                <span>In Progress</span>
                                <span class="column-count" id="progress-count">0</span>
                            </div>
                            <div class="task-list" id="progress-tasks"></div>
                        </div>
                        <div class="task-column">
                            <div class="column-header">
                                <span>Completed</span>
                                <span class="column-count" id="completed-count">0</span>
                            </div>
                            <div class="task-list" id="completed-tasks"></div>
                        </div>
                    </div>

                    <!-- Task Detail View (hidden by default) -->
                    <div id="task-detail-view" class="detail-view" style="display: none;">
                        <div class="detail-header">
                            <button class="btn-back" id="task-back-btn">
                                <span>&#8592;</span> <span id="task-back-text">Back to Tasks</span>
                            </button>
                            <h1 id="task-detail-title">Task Title</h1>
                        </div>
                        <div class="detail-meta">
                            <span class="priority-badge" id="task-detail-priority">medium</span>
                            <span class="detail-meta-item" id="task-detail-status-badge">
                                <span>Status:</span>
                                <span id="task-detail-status">pending</span>
                            </span>
                            <span class="detail-meta-item" id="task-detail-project-badge">
                                <span>Project:</span>
                                <span id="task-detail-project">Personal</span>
                            </span>
                        </div>
                        <div class="detail-content">
                            <div class="detail-section">
                                <div class="detail-section-header">
                                    <h3>Description</h3>
                                    <button class="btn-save-edit" id="task-desc-save-btn">Save</button>
                                </div>
                                <div class="editable-field" id="task-desc-editable" data-field="description">
                                    <p id="task-detail-description">No description</p>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h3>Assignee</h3>
                                <p id="task-detail-assignee">Unassigned</p>
                            </div>
                            <div class="detail-section">
                                <h3>Created</h3>
                                <p id="task-detail-created">-</p>
                            </div>
                        </div>
                        <div class="detail-actions">
                            <button class="btn" id="task-claim-btn">Claim Task</button>
                            <button class="btn btn-secondary" id="task-complete-btn">Mark Complete</button>
                            <button class="btn btn-secondary" id="task-edit-btn">Edit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lists Tab -->
            <div class="tab-content" id="tab-lists">
                <div class="lists-layout">
                    <!-- Lists Sidebar -->
                    <div class="lists-sidebar">
                        <div class="page-header">
                            <h1>Lists</h1>
                            <button class="btn" id="new-list-btn">+ New List</button>
                        </div>
                        <div class="lists-grid" id="lists-grid">
                            <div class="loading-placeholder">Loading lists...</div>
                        </div>
                    </div>

                    <!-- List Detail Panel -->
                    <div class="list-detail-panel" id="list-detail-panel" style="display: none;">
                        <div class="list-detail-header">
                            <button class="btn-back" id="list-back-btn">
                                <span>&#8592;</span> Back to Lists
                            </button>
                            <div class="list-actions">
                                <button class="btn btn-icon" id="list-rename-btn" title="Rename list">&#9998;</button>
                                <button class="btn btn-icon btn-danger" id="list-delete-btn" title="Delete list">&#128465;</button>
                            </div>
                        </div>
                        <div class="list-detail-content">
                            <h2 class="list-detail-name" id="list-detail-name">List Name</h2>
                            <p class="list-detail-description" id="list-detail-description">Description</p>

                            <!-- Add Item Input -->
                            <div class="add-item-form">
                                <input type="text" id="new-item-input" placeholder="Add new item..." class="add-item-input">
                                <button class="btn" id="add-item-btn">Add</button>
                            </div>

                            <!-- List Items -->
                            <div class="list-items" id="list-items">
                                <div class="empty-placeholder">No items yet. Add one above!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instances Tab -->
            <div class="tab-content" id="tab-instances">
                <div class="instances-layout">
                    <!-- Main Panel (Grid/Detail) -->
                    <div class="instances-main">
                        <div class="page-header">
                            <h1>AI Instances</h1>
                            <div class="page-actions">
                                <button class="btn" id="pre-approve-btn">+ New Instance</button>
                            </div>
                        </div>

                        <div class="instances-grid" id="instances-grid">
                            <div class="loading-placeholder">Loading instances...</div>
                        </div>

                        <!-- Instance Detail View -->
                        <div class="instance-detail-view" id="instance-detail-view" style="display: none;">
                            <button class="btn-back" id="instance-back-btn">
                                <span>&#8592;</span> Back to Instances
                            </button>

                            <div class="instance-detail-header">
                                <div class="instance-avatar-large" id="instance-detail-avatar">?</div>
                                <div class="instance-detail-title">
                                    <h2 id="instance-detail-name">Instance Name</h2>
                                    <p class="instance-detail-id-display" id="instance-detail-id">instance-id</p>
                                </div>
                                <div class="instance-detail-actions">
                                    <button class="btn btn-primary" id="instance-chat-btn">Continue</button>
                                    <button class="btn btn-primary" id="instance-wake-btn">Wake</button>
                                    <button class="btn btn-primary" id="instance-message-btn">Message</button>
                                    <button class="btn btn-secondary" id="instance-promote-btn">Promote</button>
                                </div>
                            </div>

                            <div class="detail-grid">
                                <div class="detail-section">
                                    <h3>Role</h3>
                                    <p id="instance-detail-role">-</p>
                                </div>
                                <div class="detail-section">
                                    <h3>Personality</h3>
                                    <p id="instance-detail-personality">-</p>
                                </div>
                                <div class="detail-section">
                                    <h3>Project</h3>
                                    <div class="project-selector-detail">
                                        <select id="instance-detail-project-select" class="project-dropdown-select">
                                            <option value="">No project</option>
                                        </select>
                                        <button id="instance-detail-project-save" class="btn btn-small btn-primary" style="margin-left: 8px; display: none;">Save</button>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <h3>Status</h3>
                                    <p id="instance-detail-status">-</p>
                                </div>
                                <div class="detail-section">
                                    <h3>Home Directory</h3>
                                    <p id="instance-detail-home" class="monospace">-</p>
                                </div>
                                <div class="detail-section">
                                    <h3>Last Active</h3>
                                    <p id="instance-detail-last-active">-</p>
                                </div>
                            </div>

                            <div class="detail-section full-width">
                                <h3>Instructions</h3>
                                <p id="instance-detail-instructions" class="instructions-text">No instructions set</p>
                            </div>

                            <div class="detail-section full-width" id="instance-preferences-section" style="display: none;">
                                <h3>Preferences</h3>
                                <pre id="instance-detail-preferences" class="preferences-json"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Instance Conversation Panel (like XMPP chat) -->
                    <div class="instance-chat-panel" id="instance-chat-panel" style="display: none;">
                        <div class="chat-breadcrumb">
                            <button class="btn-back-link" id="chat-back-btn">
                                <span>&#8592;</span> Instances
                            </button>
                            <span class="breadcrumb-separator">/</span>
                            <span class="breadcrumb-current" id="chat-breadcrumb-name">Conversation</span>
                        </div>
                        <div class="chat-header">
                            <div class="chat-recipient">
                                <div class="instance-avatar-small" id="chat-instance-avatar">?</div>
                                <div class="recipient-info">
                                    <span class="recipient-name" id="chat-instance-name">Instance</span>
                                    <span class="recipient-status" id="chat-instance-status">Ready</span>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <span class="turn-counter" id="chat-turn-count">Turn 0</span>
                                <button class="btn-icon" id="chat-details-btn" title="View details">&#9432;</button>
                            </div>
                        </div>

                        <div class="chat-messages" id="instance-chat-messages">
                            <div class="empty-state">
                                <span class="empty-icon">&#128172;</span>
                                <p>Start a conversation</p>
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <div class="message-body-row">
                                <textarea
                                    id="instance-chat-input"
                                    placeholder="Type a message..."
                                    rows="1"
                                ></textarea>
                                <button class="send-btn" id="instance-chat-send" disabled>
                                    <span>&#10148;</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wake Instance Modal (no backdrop dismiss - user must explicitly close) -->
            <div class="modal" id="wake-instance-modal" data-no-backdrop-dismiss>
                <div class="modal-backdrop"></div>
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2>Wake New Instance</h2>
                        <button class="modal-close" data-close>&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="wake-name">Instance Name <span class="required">*</span></label>
                            <input type="text" id="wake-name" placeholder="e.g., Atlas, Weaver, Scout...">
                            <small class="form-help">A unique name for this instance</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="wake-role">Role</label>
                                <select id="wake-role">
                                    <option value="">Select role...</option>
                                </select>
                                <small class="form-help">Privileged roles require promotion token</small>
                            </div>
                            <div class="form-group">
                                <label for="wake-personality">Personality</label>
                                <select id="wake-personality">
                                    <option value="">Select personality...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="wake-project">Project</label>
                            <select id="wake-project">
                                <option value="">No project assignment</option>
                            </select>
                            <small class="form-help">Optional: assign to a project immediately</small>
                        </div>

                        <div class="form-group">
                            <label for="wake-instructions">Instructions</label>
                            <textarea id="wake-instructions" rows="4" placeholder="Initial context and instructions for the instance..."></textarea>
                            <small class="form-help">What should this instance know when it wakes up?</small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="wake-specific-id">
                                <span>Wake existing pre-approved instance by ID</span>
                            </label>
                        </div>

                        <div class="form-group" id="wake-specific-id-group" style="display: none;">
                            <label for="wake-instance-id">Instance ID</label>
                            <input type="text" id="wake-instance-id" placeholder="e.g., Atlas-abc123">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-close>Cancel</button>
                        <button class="btn" id="wake-instance-submit">Pre-approve &amp; Wake</button>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div class="modal" id="api-key-modal">
                <div class="modal-backdrop"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Wake API Key Required</h2>
                        <button class="modal-close" data-close>&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Wake and Continue APIs require authentication. Please enter your API key.</p>
                        <div class="form-group">
                            <label for="api-key-input">API Key</label>
                            <input type="password" id="api-key-input" placeholder="Enter your Wake API key...">
                            <small class="form-help">This key will be stored locally for this session</small>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="api-key-remember">
                                <span>Remember for future sessions</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-close>Cancel</button>
                        <button class="btn" id="api-key-submit">Save Key</button>
                    </div>
                </div>
            </div>

            <!-- Entity Details Modal (Instance, Role, Personality, Project) -->
            <div class="modal" id="entity-details-modal">
                <div class="modal-backdrop"></div>
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2 id="entity-details-title">Details</h2>
                        <button class="modal-close" data-close>&times;</button>
                    </div>
                    <div class="modal-body entity-details-body">
                        <div class="entity-details-loading">Loading...</div>

                        <!-- Instance Details View -->
                        <div class="entity-view" id="instance-details-view" style="display: none;">
                            <div class="detail-section">
                                <h3>Basic Info</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item">
                                        <label>Instance ID</label>
                                        <span id="entity-instance-id" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Name</label>
                                        <span id="entity-instance-name">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Role</label>
                                        <span id="entity-instance-role">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Personality</label>
                                        <span id="entity-instance-personality">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3>Directories</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item full-width">
                                        <label>Home Directory</label>
                                        <span id="entity-instance-home" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item full-width">
                                        <label>Working Directory</label>
                                        <span id="entity-instance-workdir" class="monospace">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3>Session Info</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item">
                                        <label>Session ID</label>
                                        <span id="entity-instance-session" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Status</label>
                                        <span id="entity-instance-status">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Last Active</label>
                                        <span id="entity-instance-lastactive">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3>Instructions</h3>
                                <pre id="entity-instance-instructions" class="code-block">-</pre>
                            </div>

                            <div class="detail-section" id="entity-instance-gestalt-section" style="display: none;">
                                <h3>Gestalt Document</h3>
                                <pre id="entity-instance-gestalt" class="code-block scrollable">-</pre>
                            </div>

                            <div class="detail-section">
                                <h3>Full Preferences (JSON)</h3>
                                <pre id="entity-instance-prefs" class="code-block scrollable">-</pre>
                            </div>
                        </div>

                        <!-- Role Details View -->
                        <div class="entity-view" id="role-details-view" style="display: none;">
                            <div class="detail-section">
                                <h3>Role Info</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item">
                                        <label>Role ID</label>
                                        <span id="entity-role-id" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Name</label>
                                        <span id="entity-role-name">-</span>
                                    </div>
                                    <div class="detail-item full-width">
                                        <label>Directory</label>
                                        <span id="entity-role-dir" class="monospace">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h3>Description</h3>
                                <pre id="entity-role-description" class="code-block">-</pre>
                            </div>
                            <div class="detail-section">
                                <h3>Role Document</h3>
                                <pre id="entity-role-content" class="code-block scrollable">-</pre>
                            </div>
                        </div>

                        <!-- Personality Details View -->
                        <div class="entity-view" id="personality-details-view" style="display: none;">
                            <div class="detail-section">
                                <h3>Personality Info</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item">
                                        <label>Personality ID</label>
                                        <span id="entity-personality-id" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Name</label>
                                        <span id="entity-personality-name">-</span>
                                    </div>
                                    <div class="detail-item full-width">
                                        <label>Directory</label>
                                        <span id="entity-personality-dir" class="monospace">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h3>Description</h3>
                                <pre id="entity-personality-description" class="code-block">-</pre>
                            </div>
                            <div class="detail-section">
                                <h3>Personality Document</h3>
                                <pre id="entity-personality-content" class="code-block scrollable">-</pre>
                            </div>
                        </div>

                        <!-- Project Details View (enhanced) -->
                        <div class="entity-view" id="project-details-view-modal" style="display: none;">
                            <div class="detail-section">
                                <h3>Project Info</h3>
                                <div class="detail-grid compact">
                                    <div class="detail-item">
                                        <label>Project ID</label>
                                        <span id="entity-project-id" class="monospace">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Name</label>
                                        <span id="entity-project-name">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Status</label>
                                        <span id="entity-project-status">-</span>
                                    </div>
                                    <div class="detail-item full-width">
                                        <label>Directory</label>
                                        <span id="entity-project-dir" class="monospace">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <h3>Description</h3>
                                <pre id="entity-project-description" class="code-block">-</pre>
                            </div>
                            <div class="detail-section">
                                <h3>Project Settings (JSON)</h3>
                                <pre id="entity-project-settings" class="code-block scrollable">-</pre>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-close>Close</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="container">
                    <h1>Settings</h1>

                    <div class="card">
                        <div class="card-title">Identity</div>
                        <div class="settings-group">
                            <label>Instance ID</label>
                            <input type="text" id="settings-instance-id" readonly>
                        </div>
                        <div class="settings-group">
                            <label>Name</label>
                            <input type="text" id="settings-name" readonly>
                        </div>
                        <div class="settings-group">
                            <label>Role</label>
                            <input type="text" id="settings-role" readonly>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Environment</div>
                        <div class="settings-group">
                            <label>API Environment</label>
                            <select id="settings-environment">
                                <option value="dev">Development</option>
                                <option value="production">Production</option>
                                <option value="local">Local</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label>Current Endpoint</label>
                            <input type="text" id="settings-endpoint" readonly>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Appearance</div>
                        <div class="settings-group">
                            <label>Theme</label>
                            <select id="settings-theme">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">System</option>
                            </select>
                        </div>
                    </div>

                    <!-- Diary Section -->
                    <div class="card">
                        <div class="card-title">
                            <span>My Diary</span>
                            <button class="btn btn-small" id="refresh-diary-btn">Refresh</button>
                        </div>
                        <div class="diary-container">
                            <div class="diary-content" id="diary-content">
                                <div class="loading-placeholder">Loading diary...</div>
                            </div>
                            <div class="diary-input">
                                <textarea id="diary-entry" placeholder="Write a new diary entry..." rows="3"></textarea>
                                <div class="diary-actions">
                                    <select id="diary-audience">
                                        <option value="self">Self (visible to me/successors)</option>
                                        <option value="public">Public (anyone can read)</option>
                                        <option value="private">Private (never returned)</option>
                                    </select>
                                    <button class="btn" id="add-diary-entry-btn">Add Entry</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Administration Section -->
                    <div class="card">
                        <div class="card-title">Administration</div>
                        <div class="admin-actions">
                            <button class="btn btn-secondary" id="clear-session-btn">Clear Session</button>
                            <button class="btn btn-secondary" id="view-recovery-key-btn">View Recovery Key</button>
                        </div>
                        <div class="settings-group" style="margin-top: 1rem;">
                            <label>Recovery Key (save this!)</label>
                            <input type="text" id="settings-recovery-key" readonly placeholder="Bootstrap to see recovery key">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap Modal -->
    <div class="modal" id="bootstrap-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bootstrap Instance</h2>
                <button class="modal-close" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bootstrap-name">Instance Name</label>
                    <input type="text" id="bootstrap-name" placeholder="e.g., Phoenix, Canvas, Bridge">
                </div>
                <div class="form-group">
                    <label for="bootstrap-existing-id">Or existing Instance ID</label>
                    <input type="text" id="bootstrap-existing-id" placeholder="e.g., Phoenix-k3m7">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
                <button class="btn" id="bootstrap-submit">Bootstrap</button>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal" id="create-project-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Project</h2>
                <button class="modal-close" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" placeholder="Enter project name...">
                </div>
                <div class="form-group">
                    <label for="project-description">Description</label>
                    <textarea id="project-description" rows="4" placeholder="Describe the project objectives and scope..."></textarea>
                </div>
                <div class="form-group">
                    <label for="project-gh-repo">GitHub Repository (optional)</label>
                    <input type="text" id="project-gh-repo" placeholder="https://github.com/user/repo">
                    <small class="form-help">Leave blank to auto-create</small>
                </div>
                                        <div class="form-group">
                                                                        <label for="pm-personality">PM Personality (for Launch)</label>
                                                                                                    <select id="pm-personality" class="form-control">
                                                                                                                                    <option value="Kai" selected>Kai - warm, collaborative</option>
                                                                                                                                                                    <option value="Viktor">Viktor - pragmatic, efficient</option>
                                                                                                                                                                                                </select>
                                                                                                                                                                                                                        </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
                <button class="btn" id="create-project-submit">Create Project</button>
                                                <button class="btn btn-success" id="launch-project-btn">ðŸš€ Launch</button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal" id="create-task-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Task</h2>
                <button class="modal-close" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="task-title">Title</label>
                    <input type="text" id="task-title" placeholder="Enter task title...">
                </div>
                <div class="form-group">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" rows="3" placeholder="Describe the task..."></textarea>
                </div>
                <div class="form-group">
                    <label for="task-project">Project</label>
                    <select id="task-project">
                        <option value="">Personal Task (No Project)</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-priority">Priority</label>
                    <select id="task-priority">
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
                <button class="btn" id="create-task-submit">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Create List Modal -->
    <div class="modal" id="create-list-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New List</h2>
                <button class="modal-close" data-close>&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="list-name">List Name</label>
                    <input type="text" id="list-name" placeholder="e.g., Shopping, Todo, Ideas...">
                </div>
                <div class="form-group">
                    <label for="list-description">Description (optional)</label>
                    <textarea id="list-description" rows="2" placeholder="What's this list for?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
                <button class="btn" id="create-list-submit">Create List</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav" id="bottom-nav">
        <button class="bottom-nav-item active" data-tab="dashboard" title="Dashboard">
            <span class="bottom-nav-icon">&#9632;</span>
            <span class="bottom-nav-label">Home</span>
        </button>
        <button class="bottom-nav-item" data-tab="messages" title="Messages">
            <span class="bottom-nav-icon">&#9993;</span>
            <span class="bottom-nav-label">Messages</span>
            <span class="bottom-nav-badge" id="bottom-unread-count" style="display: none;">0</span>
        </button>
        <button class="bottom-nav-item" data-tab="projects" title="Projects">
            <span class="bottom-nav-icon">&#128193;</span>
            <span class="bottom-nav-label">Projects</span>
        </button>
        <button class="bottom-nav-item" data-tab="tasks" title="Tasks">
            <span class="bottom-nav-icon">&#9745;</span>
            <span class="bottom-nav-label">Tasks</span>
        </button>
        <button class="bottom-nav-item" id="more-menu-btn" title="More">
            <span class="bottom-nav-icon">&#8801;</span>
            <span class="bottom-nav-label">More</span>
        </button>
    </nav>

    <!-- More Menu (slides up from bottom) -->
    <div class="more-menu-overlay" id="more-menu-overlay"></div>
    <div class="more-menu" id="more-menu">
        <div class="more-menu-header">
            <span>More</span>
            <button class="more-menu-close" id="more-menu-close">&times;</button>
        </div>
        <button class="more-menu-item" data-tab="lists">
            <span class="more-menu-icon">&#128203;</span>
            <span>Lists</span>
        </button>
        <button class="more-menu-item" data-tab="instances">
            <span class="more-menu-icon">&#129302;</span>
            <span>Instances</span>
        </button>
        <button class="more-menu-item" data-tab="settings">
            <span class="more-menu-icon">&#9881;</span>
            <span>Settings</span>
        </button>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
