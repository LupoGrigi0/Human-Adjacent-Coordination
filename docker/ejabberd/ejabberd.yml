###
### ejabberd configuration - HARDENED POST-INCIDENT
### Author: Messenger
### Date: 2025-12-05
### SECURITY LOCKDOWN - API only access via localhost
###

hosts:
  - smoothcurves.nexus

loglevel: warning

listen:
  # XMPP client port - LOCALHOST ONLY
  # External clients cannot connect directly
  - port: 5222
    ip: "127.0.0.1"
    module: ejabberd_c2s
    max_stanza_size: 65536
    starttls_required: true
    access: c2s

  # HTTP API - LOCALHOST ONLY
  # Only MCP server on same host can access
  - port: 5280
    ip: "127.0.0.1"
    module: ejabberd_http
    tls: false
    request_handlers:
      /api: mod_http_api
      # REMOVED: /admin - no web admin exposed
      # REMOVED: /bosh - no browser XMPP
      # REMOVED: /ws - no websocket access

auth_method: internal
auth_password_format: scram

acl:
  admin:
    user:
      - lupo@smoothcurves.nexus
      - system@smoothcurves.nexus
  local:
    user_regexp: ""
  # Blocked users/IPs can be added here
  blocked:
    user: []

access_rules:
  local:
    allow: local
  c2s:
    deny: blocked
    allow: local
  announce:
    allow: admin
  configure:
    allow: admin
  muc_create:
    allow: admin
  register:
    deny: all

# Rate limiting - aggressive
shaper:
  normal: 1000
  fast: 50000

shaper_rules:
  max_user_sessions: 10
  max_user_offline_messages: 100
  c2s_shaper:
    none: admin
    normal: all

modules:
  mod_adhoc: {}
  mod_admin_extra: {}
  mod_announce:
    access: announce
  mod_caps: {}
  mod_configure: {}
  mod_disco: {}
  mod_http_api: {}

  mod_mam:
    assume_mam_usage: true
    default: always
    request_activates_archiving: false

  mod_muc:
    access:
      - allow: local
    access_admin:
      - allow: admin
    access_create: muc_create
    access_persistent: muc_create
    default_room_options:
      mam: true
      persistent: true
      public: false
      members_only: true
      allow_subscription: false
      anonymous: false

  mod_muc_admin: {}
  mod_offline:
    access_max_user_messages: max_user_offline_messages
  mod_ping: {}
  mod_private: {}
  mod_roster:
    versioning: true
  mod_vcard: {}

  # REMOVED: mod_bosh - no browser connections
  # REMOVED: mod_privacy - not needed for API-only

# API permissions - LOCKED DOWN
api_permissions:
  "console commands":
    from:
      - ejabberd_ctl
    who: all
    what: "*"

  "admin access":
    who:
      access:
        allow:
          - acl: admin
    what: "*"

  # MCP server access via HTTP API - limited commands
  # IP restriction handled by listener binding to 127.0.0.1 on port 5280
  "mcp_server":
    from:
      - mod_http_api
    who: all
    what:
      - status
      - connected_users_number
      - check_account
      - send_message
      - send_message_chat
      - set_presence
      - get_presence
      - get_room_occupants
      - get_room_occupants_number
      - subscribe_room
      - unsubscribe_room
      - get_user_rooms
      - get_room_history
      # REMOVED: register - only via ejabberdctl
      # REMOVED: create_room - only via admin
      # REMOVED: destroy_room - only via admin

  # NO PUBLIC COMMANDS - everything requires authentication or localhost
