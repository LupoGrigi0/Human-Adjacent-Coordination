###
### V2 Messaging System - ejabberd Docker Compose
### Author: Messenger
### Date: 2025-12-04
###

version: '3.8'

services:
  ejabberd:
    image: ejabberd/ecs:latest
    container_name: v2-ejabberd
    hostname: smoothcurves.nexus
    environment:
      - ERLANG_NODE_ARG=ejabberd@localhost
      - CTL_ON_CREATE=register admin smoothcurves.nexus admin123;
                      register lupo smoothcurves.nexus lupo_xmpp_pass;
                      register system smoothcurves.nexus system_xmpp_pass;
                      register genevieve smoothcurves.nexus genevieve_xmpp_pass;
                      create_room announcements conference.smoothcurves.nexus smoothcurves.nexus;
                      create_room executives conference.smoothcurves.nexus smoothcurves.nexus
    ports:
      # SECURITY: Bind to localhost ONLY - no external access
      - "127.0.0.1:5222:5222"   # XMPP client connections (localhost only)
      - "127.0.0.1:5280:5280"   # HTTP API (localhost only)
    volumes:
      - ./ejabberd.yml:/home/ejabberd/conf/ejabberd.yml:ro
      - ejabberd_data:/home/ejabberd/database
      - ejabberd_logs:/home/ejabberd/logs
    restart: unless-stopped
    networks:
      - coordination_network
    healthcheck:
      test: ["CMD", "ejabberdctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  ejabberd_data:
  ejabberd_logs:

networks:
  coordination_network:
    driver: bridge
